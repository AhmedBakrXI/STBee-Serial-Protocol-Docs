# STBee Serial Protocol

# Table of Contents

# 1. Introduction

## 1.1 Overview
This protocol depends on Command-Response-Acknowledgment `(CRA)` messages and is designed to handle multiple requests at same time.

CRA messages are binary encoded to reduce the overhead of using strings.

There are two types of messages: error-checked messages and non error checked messages introduced in DTL section.

<img src="images/client-server-communication.png" style="background-color: white; border-radius: 5px;">

# 2. Command Layer Communication
## 2.1 CRA Frame
In this protocol standard there is three types of messages.

- Command Message: always sent from the client to request some action.

- Response Message: always sent from server after processing a request from client. Response is considered acknowledgment.

- Acknowledge Message: always sent from the client after processing to tell the server that response has arrived and processed correctly, so it can close the CRA call and discard response if needed.

<img src="out/content/core/seq-simple-cra/Simple CRA Flow.svg" style="display: block; margin: 0 auto">

## 2.2 Command Format
The following figure outlines the command format which is used for communication purposes. 

<img src="images/command-frame.png">

### 2.2.1 Unique Identifier
This field contains a unique 8-bit integer used to identify each CRA session in order to allow handling multiple requests at same time and this allows handling up to 256 request at same time.

### 2.2.2 Reserved
This field contains 5-bits that are reserved for future uses and can be used as flags if needed.

### 2.2.3 Acknowledge Flag (AF)
This flag is used to distinguish between commands and acknowledge frames. It's set to zero if command and one otherwise.

### 2.2.4 Priority
Contains two bits to support four levels of priority. Server should handle higher priority commands before lower ones.

### 2.2.5 Command
This field contains 8 bits to support up to 256 commands.

### 2.2.6 Payload
This field contains any parameters sent by application layer and has maximum size of 300 bytes.


# 2.3 Response Format
The following figure outlines the response format which is used for communication purposes. 

<img src="images/response-frame.png">

### 2.3.1 Unique Identifier
This field contains a unique 8-bit integer used to identify each CRA session in order to allow handling multiple requests at same time and this allows handling up to 256 request at same time.

It's generated by client.

### 2.3.2 Status
This field contains the status of response to support easy debugging and error handling.

### 2.3.3 Response
This field contains the response to the command sent.


## 2.4 Diagrams

`حط الصور يااااااااااض يا أبو حياة`

# 3. Data Transfer Layer (DTL)

This layer provides two ways of sending messages: error-checked messages and non error checked messages.

In error-checked messages 16-bits FCS are added as footer.
On error found the error is reported to upper layer to be handled.

Slip encoding is performed as a last stage to wrap the packet and determine its length.


## 3.1 DTL Packet Format
The following figure outlines the dtl packet format.
<img src="images/dtl-packet.png" style="display: block; margin: 0 auto; background-color: white;">

### 3.1.1 CRC Enable (CRC EN)
On set to one then a 16-bit CRC is generated and attached to the packet footer, otherwise no CRC is generated.

### 3.1.2 Reserved
7 bits reserved for future use.

### 3.1.3 Payload
Contains the payload of the upper layer.

### 3.1.4 CRC 16
Optional 16-bits for CRC calculation.

### 3.1.5 SLIP Wrapper
This is used to wrap the packet before sending it to physical layer, this is important to determine the begin and end of the packet.


